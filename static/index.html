<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <meta name="description" content="Measure how many people are using your webapp"> 
    <title>Webstats</title>

    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">


    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.3/Chart.min.js"></script>

    <style>
.clean {
  color: #268bd2;
}
.btn-warning {
  font-weight: bold;
  background-color: #268bd2;
  border-color: black;
  color: white;
  text-shadow: -1px 0 #e86e17, 0 1px  #e86e17, 1px 0 #e86e17, 0 -1px #e86e17;
}

.btn-light, .btn-light:hover {
  border-color: black;
}


    </style>
</head>

<body>
<div id="page-index">
<div style="background-color: white; min-height: 100vh; padding-top: 5em;">

<br/>

<div class="container" style="max-width: 37em;">

    <div class="card border-dark bg-light">
    <div class="card-body">

    <div class="card-title"><h2><b class="clean">Simple</b> Web Analytics</h2></div>
    <h6 class="card-subtitle mb-2 text-muted">Instant Setup. No Cookies. Always Free.</h6>

    <div class="card-text">
    <p>
    The lowest possible barrier to get you started with web analytics.
    </p>

    <div id="alert" class="alert alert-warning" style="display: none;" role="alert">
    </div>

    <form method="POST" action="">
      <div class="form-group has-error">
        <input id="user" class="form-control" name="username" placeholder="Domain or username">
      </div>
      <div class="form-group">
        <input id="password" type="password" name="password" class="form-control" placeholder="Password">
      </div>

      <div class="btn-group mr-2" role="group" aria-label="First group">
        <button type="submit" onclick="post('dashboard'); return false" class="btn btn-light" name="action">Login</button>
        <a href="#" class="btn btn-light">Demo</a>
      <button type="submit" onclick="post('register'); return false" class="btn btn-dark" name="action" value="register">&nbsp;&nbsp;Register&nbsp;&nbsp;</button>
      </div>
    </form>

    </div>
    </div>
</div>

</div>
</div>

<div class="container" style="margin-bottom: 5em;">

<style>
p.short {
    max-width: 40em;

}
</style>

<h1 id="text-begin">Just Simple</h1>
<p class="short">
Clean Web Analytics is uncompromisingly simple and tries very hard to stand out of your way.
</p>

<h1>Realtime</h1>
<p class="short">
Your traffic is available at the moment it happens. See what is happening now, not yesterday.
</p>

<h1>See What Really Matters</h1>
<p class="short">
We only show our users what they actually understand. Clean Web Analytics was
carefully crafted to give you an uncluttered view. Everything is in one
printable page. No hidden menus.  
</p>

<h1>No Cookies</h1>
<p class="short">
We don't use cookies. We don't track with JavaScript. We don't do
Fingerprinting. We don't assign user indentifiers to traffic at all. Privacy is
baked in at the core technical design choices of Clean Web Analytics.
</p>

</div>


<script>

function post(name){
 user = document.getElementById("user").value
 password = document.getElementById("password").value

  fetch("/" + name, {
    method: "POST",
    body: "user=" + encodeURIComponent(user) + '&password=' + encodeURIComponent(password),
    headers: {
    'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8'
   },
 }).then(resp => {
      if (resp.status == 200){
        return resp.json()
      } else if (resp.status == 400){
        return resp.text()
      } else {
        return "Bad server status code: " + resp.status
      }
  }
).then(data => {
    if (typeof(data) === "object"){
      draw(data)
    } else {
      document.getElementById("alert").style.display = "block"
      document.getElementById("alert").innerHTML = data
    }
  })
}



function getUTCMinusElevenNow(){
    var date = new Date(); 
    var now_utc =  Date.UTC(date.getUTCFullYear(), date.getUTCMonth(), date.getUTCDate(),
      date.getUTCHours(), date.getUTCMinutes(), date.getUTCSeconds());
    
    d = new Date(now_utc);
    d.setHours(d.getHours() - 11)
    return d
}

function commaFormat(x) {
    return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
}

function average(array) {
    return array.reduce((acc, next) => acc + next) / array.length;
}

const median = arr => {
  const mid = Math.floor(arr.length / 2),
    nums = [...arr].sort((a, b) => a - b);
  return arr.length % 2 !== 0 ? nums[mid] : (nums[mid - 1] + nums[mid]) / 2;
};

function drawGraphHeader(numbers){
    document.getElementById("median").innerHTML = commaFormat(median(numbers.slice(-7)))
    document.getElementById("median_more").innerHTML = commaFormat(median(numbers.slice(-30)))
    document.getElementById("today").innerHTML = commaFormat(numbers.slice(-1)[0])

}

function draw(data){
  window.data = data
  console.log(data)
  document.getElementById("page-index").style.display = "none"
  document.getElementById("page-graphs").style.display = "block"

  orange = "#eb8034"


  function splitObject(obj, sort_keys){
    var sortable = [];
    for (var key in obj) {
        sortable.push([key, obj[key]]);
    }
    if (sort_keys){
        sortable.sort(function(a, b) {
            return a[0] - b[0];
        });
    } else {
        sortable.sort(function(a, b) {
            return b[1] - a[1];
        });
    }
  
    return [sortable.map(x => x[0]), sortable.map(x => x[1])]
  }

  function makeList(key, title){
    var elem = document.getElementById("list_" + key)


    elem.innerHTML = "<h4 class='text-muted'>" + title + "</h4>"
    if (Object.keys(data[key]).length === 0 && data[key].constructor === Object){
        elem.innerHTML += '<span class="text-muted">Empty</span>'
        return
    }

    var list = [];
    for (var vehicle in data[key]) {
        list.push([vehicle, data[key][vehicle]]);
    }
    
    list.sort(function(a, b) {
        return a[1] - b[1];
    });

    for (var i = 0; i < list.length; i++) { 
      elem.innerHTML += '<li>' + list[i][0] + ' <small class="text-muted">' + list[i][1] + '</small> <br/></li>'
    } 
  }

  var daysRange = function(s, e) {
    s = new Date(s)
    e = new Date(e)
    o = {}    
    for (var a = [], d = new Date(s); d <= e; d.setDate(d.getDate() + 1)) {
            o[new Date(d).toISOString().substring(0, 10)] = 0;
        }
        return o;
  };

  function getNormalizedDateData(){
    keys = Object.keys(data.date)
    keys.sort((a, b) => {
        return a > b;
    });
    min = keys[0]
    max = getUTCMinusElevenNow().toISOString().substring(0, 10)
    date_data = {...daysRange(min, max), ...data.date}
    return splitObject(date_data, true)
  }

  [date_keys, date_vals] = getNormalizedDateData()

  drawGraphHeader(date_vals)


  makeList("ref", "Top Referrers")
  makeList("browser", "Top Browsers")
  makeList("platform", "Top Platforms")
  makeList("loc", "Top Pages")
  makeList("lang", "Top Languages")

  document.getElementById("log").innerHTML = splitObject((data.log))[0].join("\n")

  new Chart(document.getElementById("graph"), {
    type: 'line',
    data: {
      //labels: ["2020-1-1", "2020-1-2", "2020-1-1", "2020-1-3", "2020-1-4"],
      labels: date_keys,
      datasets: [
        {
          //data: [40, 50, 46, 60, 50],
          data: date_vals,
          label: 'xxxxx',
          backgroundColor: '#268bd2',
          //pointBackgroundColor: "rgba(0,0,0,0)",
        },
      ],
    },
    options: {
      scales: {
          yAxes: [{
              ticks: {
                  beginAtZero: true
              }
          }]
      },
      legend: {display: false},
    },
  })

  function sumHours(arr){
      sum = 0
      arr.forEach(el => sum += (data.hour[el] || 0))
      return sum
  }

  new Chart(document.getElementById("time"), {
    type: 'horizontalBar',
    data: {
      labels: [
        'Morning',
        'Afternoon',
        'Evening',
        'Night',
      ],
      datasets: [
        {
          data: [
              sumHours([5, 6, 7, 8, 9, 10, 11]),
              sumHours([12, 13, 14, 15]),
              sumHours([16, 17, 18, 19, 20, 21]),
              sumHours([22, 23, 24, 0, 1, 2, 3, 4]),
          ],
          backgroundColor: [
            orange,
            orange,
            orange,
            orange,
          ],
        },
      ],
    },
    options: {
      tooltips: {
          mode: 'index'
      },
      legend: {display: false},
      scales: {
        xAxes: [
          {
            gridLines: {
              display: false,
            },
            ticks: {display: false, beginAtZero: true}
          },
        ],
        yAxes: [
          {
            gridLines: {
              display: false,
            },
            ticks: {beginAtZero: true}
          },
        ],
      },
    },
  })



  new Chart(document.getElementById("device"), {
    type: 'horizontalBar',
    data: {
      labels: [
        'Computer',
        'Phone',
        'Tablet',
        'Other',
      ],
      datasets: [
        {
          data: [
              data.device["Computer"] || 0,
              data.device["Phone"] || 0,
              data.device["Tablet"] || 0,
              ((data.device["TV"] || 0) + (data.device["Console"] || 0) + (data.device["Unknown"] || 0)),
          ],
          backgroundColor: [
            orange,
            orange,
            orange,
            orange,
          ],
        },
      ],
    },
    options: {
      tooltips: {
          mode: 'index'
      },
      legend: {display: false},
      scales: {
        xAxes: [
          {
            gridLines: {
              display: false,
            },
            ticks: {display: false, beginAtZero: true}
          },
        ],
        yAxes: [
          {
            gridLines: {
              display: false,
            },
            ticks: {beginAtZero: true}
          },
        ],
      },
    },
  })


  new Chart(document.getElementById("weekday"), {
    type: 'horizontalBar',
    data: {
      labels: ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'],
      datasets: [
        {
          data: [
            data['weekday'][0] || 0,
            data['weekday'][1] || 0,
            data['weekday'][2] || 0,
            data['weekday'][3] || 0,
            data['weekday'][4] || 0,
            data['weekday'][5] || 0,
            data['weekday'][6] || 0,
          ],
          backgroundColor: [
            orange,
            orange,
            orange,
            orange,
            orange,
            orange,
            orange,
          ],
        },
      ],
    },
    options: {
      tooltips: {
          mode: 'index'
      },
      legend: {display: false},
      scales: {
        xAxes: [
          {
            gridLines: {
              display: false,
            },
            ticks: {display: false, beginAtZero: true}
          },
        ],
        yAxes: [
          {
            gridLines: {
              display: false,
            },
          },
        ],
      },
    },
  })



}
</script>
</div>

<style>
li {
  list-style: none
}

ul {
  padding-left: 0px;

}


</style>

<div id="page-graphs" style="display: none">
  <div class="container" style="max-width: 45em;">

  <br />
  <br />

  <hr>
  <div class="row" style="margin-top: 5px">
    <div class="col-md-3">
      <h5 class="text-muted">Current</h5>
      <div class="text-monospace py-2">
        <h4 id="today">-</h4>
      </div>
    </div>
    <div class="col-md-3">
      <h5 class="text-muted">Median <small>7 days</small></h5>
      <div class="text-monospace py-2">
        <h4 id="median">-</h4>
      </div>
    </div>
    <div class="col-md-3">
      <h5 class="text-muted">Median <small>30 days</small></h5>
      <div class="text-monospace py-2">
        <h4 id="median_more">-</h4>
      </div>
    </div>
  </div>

  <div class="row" style="margin-bottom: 5px">
    <div class="col-md-12">
      <div class="border py-5 px-3">
        <canvas height="100" id="graph" />
      </div>
    </div>
  </div>

  <div class="row my-5">
    <div id="list_ref" class="col-md-6">
    </div>
    <div id="list_loc" class="col-md-6">
    </div>
  </div>

<hr>

  <div class="row my-5">
    <div class="col-md-3">
      <h5 class="text-muted">Devices</h5>
      <div class="py-2">
        <canvas id="device" height=200 />
      </div>
    </div>
    <div class="col-md-3">
      <h5 class="text-muted">Time</h5>
      <div class="py-2">
        <canvas id="time"  height=200 />
      </div>
    </div>
    <div class="col-md-3">
      <h5 class="text-muted">Weekday</h5>
      <div class="py-2">
        <canvas id="weekday"  height=200 />
      </div>
    </div>
  </div>

  <hr>

  <div class="row my-5">
    <div id="list_browser" class="col-md-4"></div>
    <div id="list_platform" class="col-md-4"></div>
    <div id="list_lang" class="col-md-4"></div>
  </div>

  <hr />


  <div class="row my-5">
    <div class="col-md-12" style="max-height: 50;">
      <h4 class="text-muted">Access Log</h4>
        <pre><code id="log">
        </pre></code>
    </div>
  </div>

  <hr />

  <div class="row my-5">
    <div class="col-md-12">
      <h4 class="text-muted">Integration</h4>
      <div class="bg-light px-3 py-3">
        <pre><code>//
// Simple Web Analytics
//
&lt;script&gt;
const formData = new FormData();
formData.append('site', 'username');
formData.append('utcoffset', '0');  // user configurable
formData.append('location', location.pathname);
formData.append('language', navigator.language || navigator.userLanguage);
formData.append('timezone', Intl.DateTimeFormat().resolvedOptions().timeZone || "")
fetch("http://localhost:8000/track", {method: "POST", body: formData})
&lt;/script&gt;
</pre></code>
      </div>
    </div>
  </div>
  </div>
</div>

<script>
const formData = new FormData();
formData.append('site', 'asdf');
formData.append('utcoffset', '0');  // user configurable
formData.append('referrer', document.referrer);
formData.append('location', location.pathname);
formData.append('language', navigator.language || navigator.userLanguage);
formData.append('timezone', Intl.DateTimeFormat().resolvedOptions().timeZone || "")
fetch("http://localhost:8000/track", {method: "POST", body: formData})
</script>


<script>
document.getElementById("user").value = "asdf"
document.getElementById("user").focus()
document.getElementById("password").value = "asdfasdf"
//document.forms[0].submit()

</script>


</body>


</html>
